local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local PingEvent = ReplicatedStorage:WaitForChild("PingEvent")
local localPlayer = Players.LocalPlayer

-- Store labels
local labels = {}

local function getPingColor(ping)
	if ping < 80 then
		return Color3.fromRGB(0, 255, 0) -- green
	elseif ping < 150 then
		return Color3.fromRGB(255, 170, 0) -- yellow
	else
		return Color3.fromRGB(255, 0, 0) -- red
	end
end

local function createPingLabel(player, character)
	if labels[player] then return end

	local head = character:WaitForChild("Head")

	local billboard = Instance.new("BillboardGui")
	billboard.Name = "PingLabel"
	billboard.Adornee = head
	billboard.Size = UDim2.fromScale(4, 1)
	billboard.StudsOffset = Vector3.new(0, 2.5, 0)
	billboard.AlwaysOnTop = true
	billboard.Parent = head

	local text = Instance.new("TextLabel")
	text.Size = UDim2.fromScale(1, 1)
	text.BackgroundTransparency = 1
	text.TextScaled = true
	text.Font = Enum.Font.GothamBold
	text.TextStrokeTransparency = 0.5
	text.Text = "-- ms"
	text.Parent = billboard

	labels[player] = text
end

local function setupPlayer(player)
	player.CharacterAdded:Connect(function(character)
		task.wait(0.5)
		createPingLabel(player, character)
	end)
end

-- Existing players
for _, player in ipairs(Players:GetPlayers()) do
	setupPlayer(player)
end

-- New players
Players.PlayerAdded:Connect(setupPlayer)

-- Receive ping updates
PingEvent.OnClientEvent:Connect(function(player, pingMs)
	local label = labels[player]
	if not label then return end

	label.Text = pingMs .. " ms"
	label.TextColor3 = getPingColor(pingMs)
end)
