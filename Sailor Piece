-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- PLAYER
local Player = Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local HRP = Character:WaitForChild("HumanoidRootPart")

-- NPC FOLDER
local NPC_FOLDER = workspace:WaitForChild("NPCs")

-- STATE
local enabled = false
local height = 5
local selectedBase = nil

-- GUI
local gui = Instance.new("ScreenGui")
gui.Name = "NPCFarmGUI"
gui.Parent = game.CoreGui

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0,300,0,340)
frame.Position = UDim2.new(0,30,0.3,0)
frame.BackgroundColor3 = Color3.fromRGB(25,25,25)
frame.Active = true
frame.Draggable = true

Instance.new("UICorner", frame).CornerRadius = UDim.new(0,12)

-- TITLE
local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1,0,0,40)
title.Text = "NPC FARM (TORSO)"
title.BackgroundTransparency = 1
title.TextColor3 = Color3.new(1,1,1)
title.Font = Enum.Font.GothamBold
title.TextScaled = true

-- TOGGLE
local toggle = Instance.new("TextButton", frame)
toggle.Position = UDim2.new(0.05,0,0,50)
toggle.Size = UDim2.new(0.9,0,0,40)
toggle.Text = "OFF"
toggle.Font = Enum.Font.GothamBold
toggle.TextScaled = true
toggle.BackgroundColor3 = Color3.fromRGB(120,40,40)
toggle.TextColor3 = Color3.new(1,1,1)

-- HEIGHT BUTTON
local heightBtn = Instance.new("TextButton", frame)
heightBtn.Position = UDim2.new(0.05,0,0,100)
heightBtn.Size = UDim2.new(0.9,0,0,35)
heightBtn.Text = "Height: 5"
heightBtn.Font = Enum.Font.Gotham
heightBtn.TextScaled = true
heightBtn.BackgroundColor3 = Color3.fromRGB(45,45,45)
heightBtn.TextColor3 = Color3.new(1,1,1)

-- DROPDOWN BUTTON
local dropdown = Instance.new("TextButton", frame)
dropdown.Position = UDim2.new(0.05,0,0,145)
dropdown.Size = UDim2.new(0.9,0,0,35)
dropdown.Text = "Select NPC Type"
dropdown.Font = Enum.Font.Gotham
dropdown.TextScaled = true
dropdown.BackgroundColor3 = Color3.fromRGB(40,40,40)
dropdown.TextColor3 = Color3.new(1,1,1)

-- DROPDOWN LIST
local list = Instance.new("ScrollingFrame", frame)
list.Position = UDim2.new(0.05,0,0,185)
list.Size = UDim2.new(0.9,0,0,140)
list.CanvasSize = UDim2.new(0,0,0,0)
list.ScrollBarImageTransparency = 0.2
list.BackgroundColor3 = Color3.fromRGB(20,20,20)
list.Visible = false

local layout = Instance.new("UIListLayout", list)
layout.Padding = UDim.new(0,6)

layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
	list.CanvasSize = UDim2.new(0,0,0,layout.AbsoluteContentSize.Y + 10)
end)

-- HELPERS
local function baseName(name)
	return name:gsub("%d+$","")
end

local function refreshDropdown()
	list:ClearAllChildren()
	layout.Parent = list

	local seen = {}

	for _,npc in ipairs(NPC_FOLDER:GetChildren()) do
		if npc:IsA("Model") and npc:FindFirstChild("Torso") then
			local base = baseName(npc.Name)
			if not seen[base] then
				seen[base] = true

				local btn = Instance.new("TextButton", list)
				btn.Size = UDim2.new(1,-10,0,30)
				btn.Text = base.." (ALL)"
				btn.Font = Enum.Font.Gotham
				btn.TextScaled = true
				btn.BackgroundColor3 = Color3.fromRGB(60,60,60)
				btn.TextColor3 = Color3.new(1,1,1)

				btn.MouseButton1Click:Connect(function()
					selectedBase = base
					dropdown.Text = "Target: "..base
					list.Visible = false
				end)
			end
		end
	end
end

local function getClosestNPC()
	local closest, dist = nil, math.huge

	for _,npc in ipairs(NPC_FOLDER:GetChildren()) do
		if npc:IsA("Model") and npc:FindFirstChild("Torso") then
			if baseName(npc.Name) == selectedBase then
				local d = (npc.Torso.Position - HRP.Position).Magnitude
				if d < dist then
					dist = d
					closest = npc
				end
			end
		end
	end

	return closest
end

-- EVENTS
toggle.MouseButton1Click:Connect(function()
	enabled = not enabled
	toggle.Text = enabled and "ON" or "OFF"
	toggle.BackgroundColor3 = enabled and Color3.fromRGB(40,120,40) or Color3.fromRGB(120,40,40)
end)

heightBtn.MouseButton1Click:Connect(function()
	height += 1
	if height > 10 then height = 1 end
	heightBtn.Text = "Height: "..height
end)

dropdown.MouseButton1Click:Connect(function()
	list.Visible = not list.Visible
	if list.Visible then
		refreshDropdown()
	end
end)

-- MAIN LOOP
RunService.Heartbeat:Connect(function()
	if enabled and selectedBase then
		local npc = getClosestNPC()
		if npc and npc.Parent and npc:FindFirstChild("Torso") then
			local torso = npc.Torso
			HRP.CFrame = CFrame.new(
				(torso.CFrame * CFrame.new(0, height, 0)).Position,
				torso.Position
			)
		end
	end
end)
