-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local Player = Players.LocalPlayer
local Char = Player.Character or Player.CharacterAdded:Wait()
local HRP = Char:WaitForChild("HumanoidRootPart")

local NPC_FOLDER = workspace:WaitForChild("NPCs")

-- STATE
local enabled = false
local height = 5
local selectedBaseName = nil

-- GUI
local gui = Instance.new("ScreenGui", game.CoreGui)
gui.Name = "NPCFarmGUI"

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.fromScale(0.25,0.35)
frame.Position = UDim2.fromScale(0.05,0.3)
frame.BackgroundColor3 = Color3.fromRGB(25,25,25)
frame.Active = true
frame.Draggable = true

Instance.new("UICorner", frame).CornerRadius = UDim.new(0,12)

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1,0,0.15,0)
title.Text = "NPC FARM"
title.BackgroundTransparency = 1
title.TextColor3 = Color3.new(1,1,1)
title.Font = Enum.Font.GothamBold
title.TextScaled = true

local toggle = Instance.new("TextButton", frame)
toggle.Position = UDim2.fromScale(0.05,0.2)
toggle.Size = UDim2.fromScale(0.9,0.15)
toggle.Text = "OFF"
toggle.Font = Enum.Font.GothamBold
toggle.TextScaled = true
toggle.BackgroundColor3 = Color3.fromRGB(120,40,40)
toggle.TextColor3 = Color3.new(1,1,1)

local heightBtn = Instance.new("TextButton", frame)
heightBtn.Position = UDim2.fromScale(0.05,0.38)
heightBtn.Size = UDim2.fromScale(0.9,0.12)
heightBtn.Text = "Height: 5"
heightBtn.Font = Enum.Font.Gotham
heightBtn.TextScaled = true
heightBtn.BackgroundColor3 = Color3.fromRGB(40,40,40)
heightBtn.TextColor3 = Color3.new(1,1,1)

local dropdown = Instance.new("TextButton", frame)
dropdown.Position = UDim2.fromScale(0.05,0.55)
dropdown.Size = UDim2.fromScale(0.9,0.12)
dropdown.Text = "Select NPC Type"
dropdown.Font = Enum.Font.Gotham
dropdown.TextScaled = true
dropdown.BackgroundColor3 = Color3.fromRGB(35,35,35)
dropdown.TextColor3 = Color3.new(1,1,1)

local list = Instance.new("Frame", frame)
list.Position = UDim2.fromScale(0.05,0.7)
list.Size = UDim2.fromScale(0.9,0.25)
list.BackgroundColor3 = Color3.fromRGB(20,20,20)
list.Visible = false

local layout = Instance.new("UIListLayout", list)
layout.Padding = UDim.new(0,4)

-- HELPERS
local function getBaseName(name)
    return name:gsub("%d+$","")
end

local function getNPCsByBase(base)
    local t = {}
    for _,npc in ipairs(NPC_FOLDER:GetChildren()) do
        if npc:IsA("Model") and npc:FindFirstChild("HumanoidRootPart") then
            if getBaseName(npc.Name) == base then
                table.insert(t, npc)
            end
        end
    end
    return t
end

local function getClosestNPC(base)
    local closest, dist = nil, math.huge
    for _,npc in ipairs(getNPCsByBase(base)) do
        local d = (npc.HumanoidRootPart.Position - HRP.Position).Magnitude
        if d < dist then
            dist = d
            closest = npc
        end
    end
    return closest
end

local function refreshDropdown()
    list:ClearAllChildren()
    layout.Parent = list

    local seen = {}
    for _,npc in ipairs(NPC_FOLDER:GetChildren()) do
        if npc:IsA("Model") and npc:FindFirstChild("HumanoidRootPart") then
            local base = getBaseName(npc.Name)
            if not seen[base] then
                seen[base] = true

                local btn = Instance.new("TextButton", list)
                btn.Size = UDim2.new(1,0,0,26)
                btn.Text = base.." (ALL)"
                btn.Font = Enum.Font.Gotham
                btn.TextScaled = true
                btn.BackgroundColor3 = Color3.fromRGB(55,55,55)
                btn.TextColor3 = Color3.new(1,1,1)

                btn.MouseButton1Click:Connect(function()
                    selectedBaseName = base
                    dropdown.Text = "Target: "..base
                    list.Visible = false
                end)
            end
        end
    end
end

-- EVENTS
toggle.MouseButton1Click:Connect(function()
    enabled = not enabled
    toggle.Text = enabled and "ON" or "OFF"
    toggle.BackgroundColor3 = enabled and Color3.fromRGB(40,120,40) or Color3.fromRGB(120,40,40)
end)

heightBtn.MouseButton1Click:Connect(function()
    height += 1
    if height > 10 then height = 1 end
    heightBtn.Text = "Height: "..height
end)

dropdown.MouseButton1Click:Connect(function()
    list.Visible = not list.Visible
    if list.Visible then
        refreshDropdown()
    end
end)

-- MAIN LOOP
RunService.Heartbeat:Connect(function()
    if enabled and selectedBaseName then
        local npc = getClosestNPC(selectedBaseName)
        if npc and npc.Parent then
            local nhrp = npc.HumanoidRootPart
            HRP.CFrame = CFrame.new(
                (nhrp.CFrame * CFrame.new(0,height,0)).Position,
                nhrp.Position
            )
        end
    end
end)
