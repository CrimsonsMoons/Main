---// SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

--// PLAYER
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local Camera = workspace.CurrentCamera

--// STATE
local State = {
	Running = false,
	AutoRefresh = true,
	CameraLock = false,
	Target = nil,
	Connections = {}
}

--// UTILS
local function disconnect(c)
	if c then c:Disconnect() end
end

local function clearConnections()
	for _, c in ipairs(State.Connections) do
		disconnect(c)
	end
	table.clear(State.Connections)
end

--// CHARACTER UTILS (UNIVERSAL)
local function getChar(plr)
	return plr.Character
end

local function getRoot(char)
	return char and (
		char:FindFirstChild("HumanoidRootPart")
		or char:FindFirstChild("UpperTorso")
		or char:FindFirstChild("Torso")
	)
end

local function getHumanoid(char)
	return char and char:FindFirstChildWhichIsA("Humanoid")
end

local function resetCamera()
	local hum = getHumanoid(LocalPlayer.Character)
	if hum then
		Camera.CameraSubject = hum
	end
end

--// GUI
local gui = Instance.new("ScreenGui", PlayerGui)
gui.Name = "UniversalFlingGUI"
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.fromOffset(260, 360)
frame.Position = UDim2.new(0, 10, 0.4, 0)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 8)

local function makeBtn(text, y, color)
	local b = Instance.new("TextButton", frame)
	b.Size = UDim2.new(1, -20, 0, 28)
	b.Position = UDim2.new(0, 10, 0, y)
	b.BackgroundColor3 = color
	b.Text = text
	b.TextColor3 = Color3.new(1,1,1)
	b.Font = Enum.Font.SourceSansBold
	b.TextSize = 14
	Instance.new("UICorner", b).CornerRadius = UDim.new(0, 6)
	return b
end

local toggleBtn = makeBtn("Start Fling", 10, Color3.fromRGB(0,170,255))
local dropdownBtn = makeBtn("Select Player", 50, Color3.fromRGB(50,50,50))
local camBtn = makeBtn("Camera Lock: OFF", 90, Color3.fromRGB(40,40,40))
local resetBtn = makeBtn("Destroy GUI", 310, Color3.fromRGB(255,60,60))

--// SPEED
local speedBox = Instance.new("TextBox", frame)
speedBox.Size = UDim2.new(1, -20, 0, 28)
speedBox.Position = UDim2.new(0, 10, 0, 130)
speedBox.Text = "1500"
speedBox.BackgroundColor3 = Color3.fromRGB(50,50,50)
speedBox.TextColor3 = Color3.new(1,1,1)
speedBox.Font = Enum.Font.SourceSans
speedBox.TextSize = 14
speedBox.ClearTextOnFocus = false
Instance.new("UICorner", speedBox).CornerRadius = UDim.new(0, 6)

--// STATUS
local status = Instance.new("TextLabel", frame)
status.Size = UDim2.new(1, -20, 0, 20)
status.Position = UDim2.new(0, 10, 0, 170)
status.Text = "Status: Idle"
status.TextColor3 = Color3.new(1,1,1)
status.BackgroundTransparency = 1
status.TextXAlignment = Enum.TextXAlignment.Left
status.Font = Enum.Font.SourceSans

--// DROPDOWN
local dropdown = Instance.new("ScrollingFrame", frame)
dropdown.Size = UDim2.new(1, -20, 0, 120)
dropdown.Position = UDim2.new(0, 10, 0, 195)
dropdown.Visible = false
dropdown.ScrollBarThickness = 6
dropdown.BackgroundColor3 = Color3.fromRGB(35,35,35)

local layout = Instance.new("UIListLayout", dropdown)
layout.Padding = UDim.new(0, 4)

--// DRAGGING
do
	local dragging, dragStart, startPos
	frame.InputBegan:Connect(function(i)
		if i.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
			dragStart = i.Position
			startPos = frame.Position
			i.Changed:Connect(function()
				if i.UserInputState == Enum.UserInputState.End then
					dragging = false
				end
			end)
		end
	end)

	RunService.RenderStepped:Connect(function()
		if dragging then
			local delta = UserInputService:GetMouseLocation() - dragStart
			frame.Position = UDim2.new(
				startPos.X.Scale,
				startPos.X.Offset + delta.X,
				startPos.Y.Scale,
				startPos.Y.Offset + delta.Y
			)
		end
	end)
end

--// PLAYER DETECTOR
local tracked = {}

local function validTarget(plr)
	if plr == LocalPlayer then return false end
	local root = getRoot(getChar(plr))
	return root ~= nil
end

local function refreshPlayers()
	for _, c in ipairs(dropdown:GetChildren()) do
		if c:IsA("TextButton") then c:Destroy() end
	end

	for _, plr in ipairs(Players:GetPlayers()) do
		if plr ~= LocalPlayer then
			tracked[plr] = true

			local btn = Instance.new("TextButton", dropdown)
			btn.Size = UDim2.new(1, -6, 0, 26)
			btn.Text = plr.Name .. " (loading)"
			btn.BackgroundColor3 = Color3.fromRGB(80,60,60)
			btn.TextColor3 = Color3.new(1,1,1)
			btn.Font = Enum.Font.SourceSans
			btn.TextSize = 14
			Instance.new("UICorner", btn).CornerRadius = UDim.new(0,6)

			task.spawn(function()
				while tracked[plr] and btn.Parent do
					if validTarget(plr) then
						btn.Text = plr.Name
						btn.BackgroundColor3 = Color3.fromRGB(60,120,60)
					else
						btn.Text = plr.Name .. " (no body)"
						btn.BackgroundColor3 = Color3.fromRGB(120,60,60)
					end
					task.wait(0.4)
				end
			end)

			btn.MouseButton1Click:Connect(function()
				if validTarget(plr) then
					State.Target = plr
					dropdownBtn.Text = "Target: " .. plr.Name
					dropdown.Visible = false
				else
					status.Text = "Status: Invalid target"
				end
			end)
		end
	end

	dropdown.CanvasSize = UDim2.new(0,0,0,layout.AbsoluteContentSize.Y)
end

refreshPlayers()

Players.PlayerAdded:Connect(refreshPlayers)
Players.PlayerRemoving:Connect(function(plr)
	tracked[plr] = nil
	refreshPlayers()
end)

LocalPlayer.CharacterAdded:Connect(function()
	task.wait(1)
	refreshPlayers()
	resetCamera()
end)

--// FLING CORE
local function startFling()
	if not State.Target then
		status.Text = "Status: No target"
		return
	end

	State.Running = true
	status.Text = "Status: Flinging " .. State.Target.Name

	local conn
	conn = RunService.Heartbeat:Connect(function(dt)
		if not State.Running then return end

		local char = getChar(LocalPlayer)
		local tChar = getChar(State.Target)
		if not char or not tChar then return end

		local root = getRoot(char)
		local tRoot = getRoot(tChar)
		if not root or not tRoot then return end

		local speed = tonumber(speedBox.Text) or 1500
		local t = os.clock() * (speed / 250)
		local offset = Vector3.new(math.cos(t), 0, math.sin(t)) * 5
		local goal = tRoot.Position + offset

		pcall(function()
			char:PivotTo(CFrame.new(goal))
		end)

		local dir = goal - root.Position
		if dir.Magnitude > 0 then
			root.AssemblyLinearVelocity = dir.Unit * math.clamp(dir.Magnitude * 7, 150, 450)
			root.AssemblyAngularVelocity = Vector3.new(6000,6000,6000)
		end

		if State.CameraLock then
			Camera.CameraSubject = tRoot
			Camera.CFrame = CFrame.new(Camera.CFrame.Position, tRoot.Position)
		end
	end)

	table.insert(State.Connections, conn)
end

local function stopFling()
	State.Running = false
	clearConnections()
	status.Text = "Status: Stopped"
	resetCamera()
end

--// BUTTONS
toggleBtn.MouseButton1Click:Connect(function()
	if State.Running then
		stopFling()
		toggleBtn.Text = "Start Fling"
	else
		startFling()
		toggleBtn.Text = "Stop Fling"
	end
end)

dropdownBtn.MouseButton1Click:Connect(function()
	dropdown.Visible = not dropdown.Visible
end)

camBtn.MouseButton1Click:Connect(function()
	State.CameraLock = not State.CameraLock
	camBtn.Text = "Camera Lock: " .. (State.CameraLock and "ON" or "OFF")
end)

resetBtn.MouseButton1Click:Connect(function()
	stopFling()
	gui:Destroy()
end)
